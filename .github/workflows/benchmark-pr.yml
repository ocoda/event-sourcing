name: Benchmark PR

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "packages/**"
      - "benchmarks/**"

concurrency:
  group: benchmark-pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout base branch benchmark report
        run: git checkout origin/${{ github.base_ref }} -- benchmarks/report/

      - name: Setup job environment
        uses: ./.github/actions/setup-job-env
        with:
          cache-key: node-22.x
          node-version: 22.x

      - name: Start databases
        run: docker compose up -d mongodb postgres mariadb dynamodb

      - name: Wait for databases
        run: |
          for service in mongodb postgres mariadb dynamodb; do
            healthy=false
            for attempt in {1..36}; do
              status=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$(docker compose ps -q $service)")
              if [ "$status" = "healthy" ] || [ "$status" = "running" ]; then
                healthy=true
                break
              fi
              sleep 5
            done
            if [ "$healthy" = "false" ]; then
              docker compose logs $service
              exit 1
            fi
          done

      - name: Run benchmarks
        run: |
          for integration in in-memory mongodb dynamodb postgres mariadb; do
            pnpm run benchmark $integration
          done

      - name: Compare with baseline
        id: compare
        run: node .github/scripts/compare-benchmarks.js

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = require('fs').readFileSync('benchmarks/report/comparison.md', 'utf8');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report-comparison
          path: ./benchmarks/report/comparison.md
