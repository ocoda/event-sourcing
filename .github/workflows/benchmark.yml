name: Benchmark

on:
  workflow_dispatch:
  push:
    branches: ["master"]
    paths:
      - benchmarks/**
      - packages/**
      - package.json
      - pnpm-*.yaml

jobs:
  artillery:
    runs-on: ubuntu-latest
    strategy:
        matrix:
            database: [mongodb, dynamodb, postgres, mariadb]
        fail-fast: true
        max-parallel: 1

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Start database
        run: docker compose up -d ${{ matrix.database }}

      - name: Setup job environment
        id: setup-job
        uses: ./.github/actions/setup-job-env
        with:
          cache-key: node-${{ matrix.node-version }}
          node-version: ${{ matrix.node-version }}

      - name: Execute load tests
        run: pnpm run benchmark ${{ matrix.database }}

      - name: Upload report (JSON)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.database }}-report-json
          path: ./report/${{ matrix.database }}.json

      - name: Upload report (HTML)
        uses: actions/upload-artifact@v4
        with:
         name: ${{ matrix.database }}-report-html
         path: ./report/${{ matrix.database }}.json.html
