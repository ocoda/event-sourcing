name: Benchmark

on:
  workflow_dispatch:
  push:
    branches:
      - master

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  generate-benchmark:
    name: Generate benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        database: [in-memory, mongodb, dynamodb, postgres, mariadb]
      fail-fast: true
      max-parallel: 1

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6

      - name: Start database
        if: ${{ matrix.database != 'in-memory' }}
        run: docker compose up -d ${{ matrix.database }}

      - name: Wait for database
        if: ${{ matrix.database != 'in-memory' }}
        run: |
          for attempt in {1..36}; do
            status=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$(docker compose ps -q ${{ matrix.database }})")
            if [ "$status" = "healthy" ] || [ "$status" = "running" ]; then
              exit 0
            fi
            sleep 5
          done
          docker compose logs ${{ matrix.database }}
          exit 1

      - name: Setup job environment
        id: setup-job
        uses: ./.github/actions/setup-job-env
        with:
          cache-key: node-22.x
          node-version: 22.x

      - name: Execute load tests
        run: pnpm run benchmark ${{ matrix.database }}

      - name: Upload report (JSON)
        uses: actions/upload-artifact@v4
        with:
          name: report-json-${{ matrix.database }}
          path: ./benchmarks/report/${{ matrix.database }}.json

  report-benchmark:
    name: Report benchmark
    needs: [generate-benchmark]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6

      - name: Download reports (JSON)
        uses: actions/download-artifact@v4
        with:
          path: ./benchmarks/report/
          pattern: report-json-*
          merge-multiple: true

      - name: Setup job environment
        id: setup-job
        uses: ./.github/actions/setup-job-env
        with:
          cache-key: node-22.x
          node-version: 22.x

      - name: Generate report (MD)
        run: pnpm run benchmark:report

      - name: Upload report (MD)
        run: cat ./benchmarks/report/report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report-md
          path: ./benchmarks/report/report.md

      - name: Update baseline cache
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@v4
        with:
          path: benchmarks/report
          key: benchmark-baseline-master-${{ github.sha }}
